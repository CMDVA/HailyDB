{% extends "base.html" %}

{% block title %}Admin Dashboard - NWS Alert Service{% endblock %}

{% block content %}
<div class="row">
    <!-- Header with Navigation -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-tachometer-alt me-2"></i>
                Admin Dashboard
            </h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="triggerIngestion()">
                    <i class="fas fa-sync-alt me-1"></i>Trigger Ingestion
                </button>
                <button type="button" class="btn btn-outline-success" onclick="refreshDashboard()">
                    <i class="fas fa-refresh me-1"></i>Refresh
                </button>
            </div>
        </div>
        
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card border-left-primary">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total Alerts
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.get('total_alerts', 0) | number_format }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card border-left-success">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            AI Enriched
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.get('enriched_alerts', 0) | number_format }}
                        </div>
                        <div class="text-xs text-muted">
                            {% if stats.get('total_alerts', 0) > 0 %}
                                {{ "%.1f"|format((stats.get('enriched_alerts', 0) / stats.get('total_alerts', 1)) * 100) }}% enriched
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-robot fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card border-left-info">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Recent (24h)
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.get('recent_alerts_24h', 0) | number_format }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card border-left-danger">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Total SPC Events
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.get('spc_total_reports', 0) | number_format }}
                        </div>
                        <div class="text-xs text-muted">
                            <span class="text-danger">{{ stats.get('spc_tornado', 0) }}</span> tornado, 
                            <span class="text-warning">{{ stats.get('spc_wind', 0) }}</span> wind, 
                            <span class="text-info">{{ stats.get('spc_hail', 0) }}</span> hail
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-bolt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Automatic Ingestion Controls Row -->
    <div class="col-xl-6 col-md-12 mb-4">
        <div class="row">
            <!-- NWS Automatic Ingestion Card -->
            <div class="col-md-6 mb-4">
                <div class="card stats-card border-left-info">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    NWS Automatic Ingestion
                                </div>
                                <div class="d-flex flex-column">
                                    <div class="d-flex align-items-center mb-2">
                                        <span id="nws-scheduler-status" class="me-2 font-weight-bold">
                                            <i class="fas fa-stop-circle me-1"></i>Stopped
                                        </span>
                                        <button id="nws-scheduler-play-btn" class="btn btn-sm btn-success me-1" onclick="onPlayNWSScheduler()" title="Start NWS automatic ingestion">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button id="nws-scheduler-pause-btn" class="btn btn-sm btn-warning" onclick="onPauseNWSScheduler()" style="display: none;" title="Stop NWS automatic ingestion">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    </div>
                                    <div id="nws-ingestion-progress" class="small text-muted" style="display: none;">
                                        <div id="nws-progress-text">Initializing...</div>
                                        <div class="progress mt-1" style="height: 4px;">
                                            <div id="nws-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div id="nws-next-ingestion-countdown" class="small text-muted" style="display: none;">
                                        Next Ingestion: <span id="nws-countdown-timer">--</span>
                                    </div>
                                    <div id="nws-last-ingestion-result" class="small" style="display: none;">
                                        <span id="nws-result-text"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-server fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SPC Automatic Ingestion Card -->
            <div class="col-md-6 mb-4">
                <div class="card stats-card border-left-warning">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    SPC Automatic Ingestion
                                </div>
                                <div class="d-flex flex-column">
                                    <div class="d-flex align-items-center mb-2">
                                        <span id="spc-scheduler-status" class="me-2 font-weight-bold">
                                            <i class="fas fa-stop-circle me-1"></i>Stopped
                                        </span>
                                        <button id="spc-scheduler-play-btn" class="btn btn-sm btn-success me-1" onclick="onPlaySPCScheduler()" title="Start SPC automatic ingestion">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button id="spc-scheduler-pause-btn" class="btn btn-sm btn-warning" onclick="onPauseSPCScheduler()" style="display: none;" title="Stop SPC automatic ingestion">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    </div>
                                    <div id="spc-ingestion-progress" class="small text-muted" style="display: none;">
                                        <div id="spc-progress-text">Initializing...</div>
                                        <div class="progress mt-1" style="height: 4px;">
                                            <div id="spc-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div id="spc-next-ingestion-countdown" class="small text-muted" style="display: none;">
                                        Next Ingestion: <span id="spc-countdown-timer">--</span>
                                    </div>
                                    <div id="spc-last-ingestion-result" class="small" style="display: none;">
                                        <span id="spc-result-text"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-cloud-bolt fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- SPC Automatic Ingestion Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card border-left-warning">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            SPC Automatic Ingestion
                        </div>
                        <div class="d-flex flex-column">
                            <div class="d-flex align-items-center mb-2">
                                <span id="spc-scheduler-status" class="me-2 font-weight-bold">
                                    <i class="fas fa-stop-circle me-1"></i>Stopped
                                </span>
                                <button id="spc-scheduler-play-btn" class="btn btn-sm btn-success me-1" onclick="onPlaySPCScheduler()" title="Start automatic SPC ingestion">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button id="spc-scheduler-pause-btn" class="btn btn-sm btn-warning" onclick="onPauseSPCScheduler()" style="display: none;" title="Stop automatic SPC ingestion">
                                    <i class="fas fa-pause"></i>
                                </button>
                            </div>
                            <div id="spc-ingestion-progress" class="small text-muted" style="display: none;">
                                <div id="spc-progress-text">Initializing...</div>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div id="spc-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" style="width: 0%"></div>
                                </div>
                            </div>
                            <div id="spc-next-ingestion-countdown" class="small text-muted" style="display: none;">
                                Next Ingestion: <span id="spc-countdown-timer">--</span>
                            </div>
                            <div id="spc-last-ingestion-result" class="small" style="display: none;">
                                <span id="spc-result-text"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-cloud-bolt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
        <!-- Today's Data Verification -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">Today's Alerts</h6>
                        <a href="{{ url_for('get_alerts') }}" class="btn btn-sm btn-outline-primary">
                            View All <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                    <div class="card-body">
                        <div id="todays-alerts-table">
                            Loading today's alerts...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">Today's SPC Events</h6>
                        <a href="/spc/reports" class="btn btn-sm btn-outline-primary">
                            View All <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                    <div class="card-body">
                        <div id="todays-spc-events">
                            Loading today's SPC events...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        </div>

<!-- System Status Row -->
<div class="row mb-4">
    <div class="col-xl-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">System Status</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">Ingestion Status</h6>
                        <p class="mb-1">
                            <strong>Last Ingestion:</strong> 
                            <span id="last-ingestion">
                                {% if stats.get('last_ingestion') %}
                                    {{ stats.last_ingestion.strftime('%Y-%m-%d %H:%M:%S UTC') if stats.last_ingestion else 'Never' }}
                                {% else %}
                                    Never
                                {% endif %}
                            </span>
                        </p>
                        <p class="mb-1">
                            <strong>Polling Interval:</strong> 5 minutes
                        </p>
                        <p class="mb-3">
                            <strong>Next Poll:</strong> <span id="next-poll">Calculating...</span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">API Health</h6>
                        <div class="d-flex align-items-center mb-2">
                            <div class="status-dot bg-success me-2"></div>
                            <span>NWS API: Operational</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="status-dot bg-success me-2"></div>
                            <span>Database: Connected</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="status-dot bg-{{ 'success' if stats.get('enriched_alerts', 0) > 0 else 'warning' }} me-2"></div>
                            <span>OpenAI API: {{ 'Available' if stats.get('enriched_alerts', 0) > 0 else 'Check Configuration' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="col-xl-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">System Controls</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" onclick="runFullUpdate()" id="run-button">
                        <i class="fas fa-play me-1"></i>
                        Run Full Update
                    </button>
                    <small class="text-muted text-center">Polls NWS alerts, ingests SPC data, and runs matching</small>
                    
                    <hr>
                    
                    <button class="btn btn-outline-primary" onclick="triggerIngestion()">
                        <i class="fas fa-sync-alt me-1"></i>
                        NWS Alerts Only
                    </button>
                    
                    <button class="btn btn-outline-success" onclick="enrichBatch()">
                        <i class="fas fa-robot me-1"></i>
                        AI Enrichment
                    </button>
                    
                    <button class="btn btn-outline-info" onclick="viewMetrics()">
                        <i class="fas fa-chart-line me-1"></i>
                        View Metrics
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Hidden data for JavaScript -->
<script type="application/json" id="dashboard-data">
{
    "scheduler_running": {{ stats.get('scheduler_running', false) | tojson }}
}
</script>
{% endblock %}

{% block scripts %}
<script>
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initializeDashboard();
    });
</script>
{% endblock %}
