{% extends "base.html" %}

{% block title %}Admin Dashboard - NWS Alert Service{% endblock %}

{% block content %}
<div class="row">
    <!-- Header with Navigation -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-tachometer-alt me-2"></i>
                Admin Dashboard
            </h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="triggerIngestion()">
                    <i class="fas fa-sync-alt me-1"></i>Trigger Ingestion
                </button>
                <button type="button" class="btn btn-outline-success" onclick="refreshDashboard()">
                    <i class="fas fa-refresh me-1"></i>Refresh
                </button>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button" role="tab">
                    <i class="fas fa-exclamation-triangle me-1"></i>Alerts
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="spc-events-tab" data-bs-toggle="tab" data-bs-target="#spc-events" type="button" role="tab">
                    <i class="fas fa-bolt me-1"></i>SPC Events
                </button>
            </li>
        </ul>
    </div>
</div>

<div class="tab-content" id="mainTabContent">
    <div class="tab-pane fade show active" id="dashboard" role="tabpanel">

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card border-left-primary">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total Alerts
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.get('total_alerts', 0) | number_format }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card border-left-success">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            AI Enriched
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.get('enriched_alerts', 0) | number_format }}
                        </div>
                        <div class="text-xs text-muted">
                            {% if stats.get('total_alerts', 0) > 0 %}
                                {{ "%.1f"|format((stats.get('enriched_alerts', 0) / stats.get('total_alerts', 1)) * 100) }}% enriched
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-robot fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card border-left-info">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Recent (24h)
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.get('recent_alerts_24h', 0) | number_format }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card border-left-danger">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Total SPC Events
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.get('spc_total_reports', 0) | number_format }}
                        </div>
                        <div class="text-xs text-muted">
                            <span class="text-danger">{{ stats.get('spc_tornado', 0) }}</span> tornado, 
                            <span class="text-warning">{{ stats.get('spc_wind', 0) }}</span> wind, 
                            <span class="text-info">{{ stats.get('spc_hail', 0) }}</span> hail
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-bolt fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card border-left-warning">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Scheduler Status
                        </div>
                        <div class="h5 mb-0 font-weight-bold">
                            {% if stats.get('scheduler_running') %}
                                <span class="text-success">
                                    <i class="fas fa-play-circle me-1"></i>Running
                                </span>
                            {% else %}
                                <span class="text-danger">
                                    <i class="fas fa-pause-circle me-1"></i>Stopped
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-cogs fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- SPC Events Overview -->
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">SPC Events Overview</h6>
                <div class="btn-group" role="group">
                    <a href="/spc/reports" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye me-1"></i>View All Events
                    </a>
                    <a href="/internal/spc-verify" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-shield-alt me-1"></i>Verify Data Integrity
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center border-end">
                            <div class="h2 text-danger mb-0">{{ stats.get('spc_tornado', 0) }}</div>
                            <div class="text-muted">Tornado Reports</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center border-end">
                            <div class="h2 text-warning mb-0">{{ stats.get('spc_wind', 0) }}</div>
                            <div class="text-muted">Wind Reports</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="h2 text-info mb-0">{{ stats.get('spc_hail', 0) }}</div>
                            <div class="text-muted">Hail Reports</div>
                        </div>
                    </div>
                </div>
                

            </div>
        </div>
    </div>
</div>

<!-- System Status Row -->
<div class="row mb-4">
    <div class="col-xl-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">System Status</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">Ingestion Status</h6>
                        <p class="mb-1">
                            <strong>Last Ingestion:</strong> 
                            <span id="last-ingestion">
                                {% if stats.get('last_ingestion') %}
                                    {{ stats.last_ingestion.strftime('%Y-%m-%d %H:%M:%S UTC') if stats.last_ingestion else 'Never' }}
                                {% else %}
                                    Never
                                {% endif %}
                            </span>
                        </p>
                        <p class="mb-1">
                            <strong>Polling Interval:</strong> 5 minutes
                        </p>
                        <p class="mb-3">
                            <strong>Next Poll:</strong> <span id="next-poll">Calculating...</span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">API Health</h6>
                        <div class="d-flex align-items-center mb-2">
                            <div class="status-dot bg-success me-2"></div>
                            <span>NWS API: Operational</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="status-dot bg-success me-2"></div>
                            <span>Database: Connected</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="status-dot bg-{{ 'success' if stats.get('enriched_alerts', 0) > 0 else 'warning' }} me-2"></div>
                            <span>OpenAI API: {{ 'Available' if stats.get('enriched_alerts', 0) > 0 else 'Check Configuration' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="col-xl-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">System Controls</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="triggerIngestion()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Manual Ingestion
                    </button>
                    
                    <button class="btn btn-success" onclick="enrichBatch()">
                        <i class="fas fa-robot me-1"></i>
                        Enrich Batch
                    </button>
                    
                    <button class="btn btn-info" onclick="viewMetrics()">
                        <i class="fas fa-chart-line me-1"></i>
                        View Metrics
                    </button>
                    
                    <hr>
                    
                    <button class="btn btn-outline-warning" onclick="toggleScheduler()">
                        <i class="fas fa-pause me-1"></i>
                        <span id="scheduler-toggle">Toggle Scheduler</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Today's Data Verification -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Today's Alerts</h6>
                <a href="{{ url_for('get_alerts') }}" class="btn btn-sm btn-outline-primary">
                    View All <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            <div class="card-body">
                <div id="todays-alerts-table">
                    Loading today's alerts...
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Today's SPC Events</h6>
                <a href="/spc/reports" class="btn btn-sm btn-outline-primary">
                    View All <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            <div class="card-body">
                <div id="todays-spc-events">
                    Loading today's SPC events...
                </div>
            </div>
        </div>
    </div>
</div>

    </div> <!-- End Dashboard Tab -->

    <!-- Alerts Tab -->
    <div class="tab-pane fade" id="alerts" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Alert Search</h6>
                    </div>
                    <div class="card-body">
                        <form class="row g-3 mb-4">
                            <div class="col-md-3">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate" name="start_date">
                            </div>
                            <div class="col-md-3">
                                <label for="endDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate" name="end_date">
                            </div>
                            <div class="col-md-3">
                                <label for="eventType" class="form-label">Event Type</label>
                                <select class="form-select" id="eventType" name="event">
                                    <option value="">All Types</option>
                                    <option value="Tornado Warning">Tornado Warning</option>
                                    <option value="Severe Thunderstorm Warning">Severe Thunderstorm Warning</option>
                                    <option value="Flash Flood Warning">Flash Flood Warning</option>
                                    <option value="Winter Storm Warning">Winter Storm Warning</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="severity" class="form-label">Severity</label>
                                <select class="form-select" id="severity" name="severity">
                                    <option value="">All Severities</option>
                                    <option value="Extreme">Extreme</option>
                                    <option value="Severe">Severe</option>
                                    <option value="Moderate">Moderate</option>
                                    <option value="Minor">Minor</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Search Alerts</button>
                                <button type="reset" class="btn btn-secondary">Clear</button>
                            </div>
                        </form>
                        <div id="alerts-results">
                            <p class="text-muted">Use the filters above to search for alerts.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SPC Events Tab -->
    <div class="tab-pane fade" id="spc-events" role="tabpanel">
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">SPC Event Search</h6>
                    </div>
                    <div class="card-body">
                        <form class="row g-3 mb-4">
                            <div class="col-md-3">
                                <label for="spcStartDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="spcStartDate" name="start_date">
                            </div>
                            <div class="col-md-3">
                                <label for="spcEndDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="spcEndDate" name="end_date">
                            </div>
                            <div class="col-md-3">
                                <label for="reportType" class="form-label">Report Type</label>
                                <select class="form-select" id="reportType" name="report_type">
                                    <option value="">All Types</option>
                                    <option value="tornado">Tornado</option>
                                    <option value="wind">Wind</option>
                                    <option value="hail">Hail</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Search SPC Events</button>
                                <button type="reset" class="btn btn-secondary">Clear</button>
                            </div>
                        </form>
                        <div id="spc-results">
                            <p class="text-muted">Use the filters above to search for SPC events.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div> <!-- End Tab Content -->

<!-- Hidden data for JavaScript -->
<script type="application/json" id="dashboard-data">
{
    "scheduler_running": {{ stats.get('scheduler_running', false) | tojson }}
}
</script>
{% endblock %}

{% block scripts %}
<script>
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initializeDashboard();
    });
</script>
{% endblock %}
